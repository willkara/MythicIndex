# Mythic Index Frontend

This directory contains the frontend for Mythic Index, built with a Cloudflare Native architecture using SvelteKit, D1, and Cloudflare Workers.

## Features Implemented

*   **Framework:** SvelteKit 5 (Runes) + TypeScript.
*   **Database:** Cloudflare D1 (SQLite) with Drizzle ORM.
*   **Styling:** TailwindCSS.
*   **Key Views:**
    *   `/canon`: Browses Characters, Locations, and Chapters from D1.
    *   `/reader/[slug]`: Renders Markdown content for a specific item.
    *   `/admin/upload`: Uploads Markdown files to be ingested into D1.
*   **Ingestion:** A TypeScript-based Markdown parser (`MarkdownBlockParser`) that extracts metadata and content.

## How to Run Locally

1.  **Install Dependencies:**
    ```bash
    npm install
    ```

2.  **Setup Database:**
    Generate migrations and apply them to the local D1 emulator:
    ```bash
    npx wrangler d1 execute memoryquill-dev --local --file=drizzle/0000_ambitious_sleeper.sql
    ```

3.  **Seed Data:**
    Populate the database with sample data:
    ```bash
    npx wrangler d1 execute memoryquill-dev --local --file=seed.sql
    ```

4.  **Run Development Server:**
    ```bash
    npm run dev -- --open
    ```
    This will start the SvelteKit app bound to the local Cloudflare Workers emulator.

## Deployment to Cloudflare Pages

### Prerequisites
- Ensure `CLOUDFLARE_API_TOKEN` environment variable is set
- Install wrangler CLI: `npm install -g wrangler`
- Project name on Cloudflare Pages: `mythicindex`

### Build and Deploy

1.  **Install Dependencies:**
    ```bash
    npm install
    ```

2.  **Build for Production:**
    ```bash
    npm run build
    ```
    - Builds SvelteKit app with Cloudflare adapter
    - Output: `.svelte-kit/cloudflare/` directory
    - Build time: ~7-10 seconds
    - May show 4 minor Svelte linting warnings (non-blocking)

3.  **Deploy to Cloudflare Pages:**
    ```bash
    npx wrangler pages deploy .svelte-kit/cloudflare --project-name=mythicindex --commit-dirty=true
    ```
    - Uploads built assets to Cloudflare Pages
    - Uses configuration from `wrangler.toml`
    - D1 database binding: `mythicindex-db` (database_id: `a3f97481-6340-44c7-ae75-06dcf0c76ac2`)
    - Environment variables from wrangler.toml: `CLOUDFLARE_ACCOUNT_HASH`, `CLOUDFLARE_DELIVERY_BASE_URL`

4.  **Verify Deployment:**
    - Production URL: https://mythicindex.com
    - Pages.dev URL: https://mythicindex.pages.dev
    - Preview URLs are generated for each deployment (e.g., `https://[hash].mythicindex.pages.dev`)

### Configuration Files
- `wrangler.toml` - Cloudflare Pages config, D1 bindings, environment variables
- `svelte.config.js` - SvelteKit adapter-cloudflare configuration
- `vite.config.ts` - Build configuration

### Known Issues (Non-Blocking)
- TypeScript check (`npm run check`) fails with type errors but doesn't prevent deployment
- Build succeeds and application runs correctly in production

## Directory Structure

*   `src/lib/server/db`: Database schema (Drizzle) and connection logic.
*   `src/lib/server/ingestion`: TypeScript port of the Python ingestion logic.
*   `src/routes/canon`: The "Canon Browser" page.
*   `src/routes/reader`: The content reader page.
*   `src/routes/admin/upload`: The ingestion upload tool.
*   `drizzle/`: SQL migrations generated by Drizzle Kit.

## Next Steps

1.  **Refine Parser:** Expand `MarkdownBlockParser` to handle complex Mythic Index blocks (Dialogue, Scenes).
2.  **Cloudflare Storage:** Integrate R2 for image storage.
3.  **Vector Search:** Integrate Cloudflare Vectorize for semantic search.
