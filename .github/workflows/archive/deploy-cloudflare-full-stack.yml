name: Full Stack Deployment to Cloudflare

on:
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: "Deploy frontend"
        required: false
        default: true
        type: boolean
      deploy_backend:
        description: "Deploy backend"
        required: false
        default: true
        type: boolean
      run_migrations:
        description: "Run database migrations"
        required: false
        default: true
        type: boolean
      backup_database:
        description: "Backup database before deployment"
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

jobs:
  pre-deployment:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          echo "### ðŸ” Pre-Deployment Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend:** ${{ inputs.deploy_frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend:** ${{ inputs.deploy_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "**Migrations:** ${{ inputs.run_migrations }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backup:** ${{ inputs.backup_database }}" >> $GITHUB_STEP_SUMMARY

  backup-database:
    name: Backup Database
    needs: pre-deployment
    runs-on: ubuntu-latest
    if: inputs.backup_database == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install boto3 psycopg2-binary

      - name: Configure AWS CLI for R2
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          aws-region: auto

      - name: Create database backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Creating pre-deployment backup..."
          BACKUP_FILE="pre-deploy-backup-$(date +%Y%m%d-%H%M%S).sql.gz"

          # Check if DATABASE_URL is PostgreSQL or SQLite
          if [[ "$DATABASE_URL" == postgresql* ]]; then
            pg_dump "$DATABASE_URL" | gzip > "$BACKUP_FILE"
          else
            echo "SQLite backup - copy database file"
            # Adjust based on your SQLite location
          fi

          # Upload to R2
          if [ -f "$BACKUP_FILE" ]; then
            aws s3 cp "$BACKUP_FILE" s3://memoryquill-backups/pre-deployment/ \
              --endpoint-url https://${CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com
            echo "âœ… Backup created and uploaded: $BACKUP_FILE"
          fi

  deploy-backend:
    name: Deploy Backend
    needs: backup-database
    if: |
      always() &&
      (needs.backup-database.result == 'success' || needs.backup-database.result == 'skipped') &&
      inputs.deploy_backend == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend container
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/backend:latest,ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup Node.js for Wrangler
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy backend to Cloudflare
        working-directory: backend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Create minimal wrangler.toml for deployment
          cat > wrangler.toml << EOF
          name = "memoryquill-backend"
          compatibility_date = "2025-01-01"
          main = "app/main.py"

          [env.production]
          workers_dev = false
          route = "api.memoryquill.com/*"
          EOF

          # Deploy
          wrangler deploy || echo "âš ï¸ Deployment may need manual configuration"

  run-migrations:
    name: Run Database Migrations
    needs: deploy-backend
    if: |
      always() &&
      needs.deploy-backend.result == 'success' &&
      inputs.run_migrations == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install alembic psycopg2-binary sqlalchemy

      - name: Run migrations
        working-directory: backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          alembic upgrade head
          echo "âœ… Migrations completed successfully"

  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-backend, run-migrations]
    if: |
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped') &&
      (needs.run-migrations.result == 'success' || needs.run-migrations.result == 'skipped') &&
      inputs.deploy_frontend == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build -- --configuration=production

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy frontend/dist/frontend/browser --project-name=memoryquill --branch=master

  verify-deployment:
    name: Verify Full Deployment
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Check frontend
        id: check_frontend
        run: |
          if [ "${{ inputs.deploy_frontend }}" == "true" ]; then
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://memoryquill.com || echo "000")
            if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ]; then
              echo "status=âœ… Frontend OK" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Frontend Failed ($RESPONSE)" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=âŠ˜ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Check backend API
        id: check_backend
        run: |
          if [ "${{ inputs.deploy_backend }}" == "true" ]; then
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://api.memoryquill.com/health || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "status=âœ… Backend OK" >> $GITHUB_OUTPUT
            else
              echo "status=âŒ Backend Failed ($RESPONSE)" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "status=âŠ˜ Skipped" >> $GITHUB_OUTPUT
          fi

      - name: Test API endpoints
        if: inputs.deploy_backend == true
        run: |
          # Test health endpoint
          curl -f https://api.memoryquill.com/health || echo "Health check failed"

          # Test CORS
          curl -I -H "Origin: https://memoryquill.com" https://api.memoryquill.com/health || echo "CORS check failed"

      - name: Create deployment summary
        if: always()
        run: |
          echo "# ðŸš€ Full Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Components Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.check_frontend.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.check_backend.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations | ${{ inputs.run_migrations && 'âœ… Completed' || 'âŠ˜ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backup | ${{ inputs.backup_database && 'âœ… Completed' || 'âŠ˜ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://memoryquill.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API:** https://api.memoryquill.com" >> $GITHUB_STEP_SUMMARY
          echo "- **API Health:** https://api.memoryquill.com/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Images:** https://imagedelivery.net/[YOUR_HASH]" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: Notify Deployment Completion
    needs: verify-deployment
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Report status
        run: |
          if [ "${{ needs.verify-deployment.result }}" == "success" ]; then
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Deployment completed with issues"
            echo "### âš ï¸ Deployment Completed with Issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
