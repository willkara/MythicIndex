name: Deploy Frontend to Azure CDN

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev or prod)'
        required: true
        type: choice
        options:
          - dev
          - prod
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-azure-frontend.yml'

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    name: Build and Deploy Frontend - ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build Angular app
        run: |
          cd frontend
          npm run build -- --configuration=production
        env:
          # Pass API URL from environment
          API_URL: ${{ vars.API_URL }}

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get storage account name
        id: storage
        run: |
          STORAGE_ACCOUNT=$(az storage account list \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --query "[?tags.Project=='memoryquill' && tags.Environment=='${{ github.event.inputs.environment || 'dev' }}'].name" \
            -o tsv)
          echo "account_name=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT

      - name: Upload to Blob Storage ($web container)
        run: |
          cd frontend/dist
          az storage blob upload-batch \
            --account-name ${{ steps.storage.outputs.account_name }} \
            --auth-mode login \
            --destination '$web' \
            --source . \
            --overwrite \
            --no-progress

      - name: Get CDN details
        id: cdn
        run: |
          # Get CDN profile and endpoint names
          CDN_PROFILE=$(az cdn profile list \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)

          CDN_ENDPOINT=$(az cdn endpoint list \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --profile-name $CDN_PROFILE \
            --query "[?contains(name, 'spa')].name" -o tsv)

          CDN_URL=$(az cdn endpoint show \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --profile-name $CDN_PROFILE \
            --name $CDN_ENDPOINT \
            --query hostName -o tsv)

          echo "profile=$CDN_PROFILE" >> $GITHUB_OUTPUT
          echo "endpoint=$CDN_ENDPOINT" >> $GITHUB_OUTPUT
          echo "url=https://$CDN_URL" >> $GITHUB_OUTPUT

      - name: Purge CDN cache
        run: |
          echo "Purging CDN cache for SPA files..."
          az cdn endpoint purge \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} \
            --profile-name ${{ steps.cdn.outputs.profile }} \
            --name ${{ steps.cdn.outputs.endpoint }} \
            --content-paths \
              "/index.html" \
              "/main.*.js" \
              "/polyfills.*.js" \
              "/runtime.*.js" \
              "/styles.*.css" \
              "/*.json"

          echo "âœ… CDN cache purged successfully"

      - name: Wait for CDN propagation
        run: |
          echo "Waiting 30 seconds for CDN propagation..."
          sleep 30

      - name: Verify deployment
        run: |
          CDN_URL="${{ steps.cdn.outputs.url }}"
          echo "Verifying deployment at: $CDN_URL"

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $CDN_URL || echo "000")
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… Frontend is accessible!"
              break
            else
              echo "Attempt $i/5: Got HTTP $HTTP_CODE, retrying in 10s..."
              if [ $i -eq 5 ]; then
                echo "âš ï¸ Could not verify deployment, but files were uploaded successfully"
              fi
              sleep 10
            fi
          done

      - name: Deployment Summary
        run: |
          echo "### ðŸš€ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Account:** \`${{ steps.storage.outputs.account_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**CDN Profile:** \`${{ steps.cdn.outputs.profile }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**CDN Endpoint:** \`${{ steps.cdn.outputs.endpoint }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ steps.cdn.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Uploaded to: \`$web\` container in \`${{ steps.storage.outputs.account_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- CDN cache purged for latest files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Custom Domain Setup (if applicable)" >> $GITHUB_STEP_SUMMARY
          echo "If using a custom domain, ensure DNS CNAME points to:" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.cdn.outputs.endpoint }}.azureedge.net\`" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.event.inputs.environment || 'dev' }}-${{ github.sha }}
          path: frontend/dist
          retention-days: 7
